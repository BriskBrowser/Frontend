{"version":3,"sources":["webpack://briskbrowser-frontend/./src/devtoolswebsocket.js","webpack://briskbrowser-frontend/./src/deepclone.js","webpack://briskbrowser-frontend/./src/session.js","webpack://briskbrowser-frontend/./src/index.js","webpack://briskbrowser-frontend/./src/loadbalancer.js"],"names":["devToolsWebsocket","WebSocket","constructor","host","super","sessionId","method","params","Promise","resolve","reject","this","send","JSON","stringify","id","nextid","callbacks","eventListeners","childSockets","addEventListener","evt","d","parse","data","result","error","forEach","x","handleMessage","devToolsSession","ws","req","msg","filter","push","deepClone","obj","hash","WeakMap","Object","Function","HTMLElement","sharable","undefined","has","get","set","assign","keys","map","key","Session","baseSession","sessionState","preventscroll","nextLayerUpdates","comittedLayerUpdates","layer_tree","keyboard","showing","onNewSession","onSessionActivate","onSessionSetHeight","layerUpdate","targets","nextProptrees","propertyTreesJSON","fullUpdateRequired","concat","comittedProptrees","scheduleUpdateScreen","updateKeyboard","ele","domElement_","remove","toLowerCase","touch","bind","passive","document","createElement","style","oninput","keyboardHandler","keyboardUpdateBlockedCtr","appendChild","updateScreen","innerText","inputBoxValue","setSelectionRange","selectionStart","selectionEnd","focus","onmousedown","e","preventDefault","blur","target","value","decodeLayerInfo","l","decoded","split","length","reduce","m","i","trim","res","layerId","layer_id","drawsContent","Bounds","name","bounds","parseInt","offsetToTransformParent","OffsetToTransformParent","parseFloat","replace","clip_tree_index","effect_tree_index","scroll_tree_index","transform_tree_index","createDOMTransformNode","t","zIndex","adopt","parent_id","dom","adoptable","oldZIndex","Math","max","parentNode","classList","add","setAttribute","clip","width","height","top","left","transform","toCss","local","scroll","preventscrollElem","element_id","id_","onscroll","scrollHandler","toggle","updateTargetHeights","backendNodeId","containingQuads","floor","scrollLeft","y","scrollTop","then","createDOMLayerImages","images","activeInLayer","position","createDOMLayerNode","transform_id","scrollable","scrolldom","overflow","createTargetNode","targetTouch","type","touches","currentTarget","metadata","touchStarted","cancel","container","matrix","Array","fill","reverse","_","join","makeTrees","propTrees","clip_tree","nodes","effect_tree","scroll_tree","transform_tree","get_tree_node","a","Number","isInteger","clip_id","requestAnimationFrameCallback","cancelAnimationFrame","requestAnimationFrame","layerDeleted","layerInfo","bufferUpdates","bufUpdate","splice","domImage","image","Image","src","decode","targetDeleted","old_target","old_transform_tree","resize","window","innerHeight","innerWidth","deviceScaleFactor","devicePixelRatio","mobile","n","touchPoints","clientX","clientY","identifier","destroy","domElement","options","fullscreen","BBOptionsOverrides","async","rootElement","wsPromise","websocketServer","websocketPool","socketPool","checkDone","resolved","doneCount","highestOpen","goodSocketPool","load","sort","b","selected","lasterr","close","random","pow","location","origin","s","onopen","onerror","err","socket","sessions","navigator","userAgent","match","alert","discover","targetInfo","attached","targetId","flatten","console","log","sess","addSession","sessionActivate","fps","targetBandwidth","url","currentURL","arrangeSessions","values","path","pathname","search","startsWith","substring","href","sessionSetHeight","fromSessionId","toSessionId","childArrangement","elem","querySelector","activeSession","existingSession","quertSelector","init"],"mappings":"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","file":"index.js","sourcesContent":["// Implements the chrome devtools protocol on top of a websocket.\nexport class devToolsWebsocket extends WebSocket {\n  constructor(host){\n    super(host + '/devtools/browser');\n    this.nextid=0;\n    this.callbacks = [];\n    this.eventListeners = [];\n    this.childSockets = [];\n    this.addEventListener('message', (evt) => {\n      var d = JSON.parse(evt.data);\n      if (this.callbacks[d.id]) {\n        if (d.result)\n          this.callbacks[d.id].resolve(d.result);\n        else\n          this.callbacks[d.id].reject(d.error);\n        delete this.callbacks[d.id];\n      } else\n      if (this.eventListeners[d.method])\n        this.eventListeners[d.method](d.params)\n      this.childSockets.forEach(x=>x.handleMessage(d));\n    });\n  } \n  req = (sessionId, method, params) => {\n    return new Promise((resolve, reject) => {\n      this.send(JSON.stringify({\n        id: this.nextid,\n        method,\n        params,\n        sessionId,\n      }));\n      this.callbacks[this.nextid] = {resolve, reject}\n      this.nextid++;\n    });\n  }\n}\n\n// Points to a devToolsWebsocket and can perform requests on a specific session.\nexport class devToolsSession {\n  constructor (ws, sessionId) {\n    this.ws = ws;\n    this.sessionId = sessionId;\n    this.eventListeners = [];\n    this.ws.childSockets.push(this);\n  }\n  req = (method, params) => {\n    return this.ws.req(this.sessionId, method, params);\n  }\n  handleMessage = (msg) => {\n    if (msg.sessionId == this.sessionId  && this.eventListeners[msg.method])\n        this.eventListeners[msg.method](msg.params);\n  }\n  destroy = () => {\n    this.ws.childSockets = this.ws.childSockets.filter(x=> x != this);\n  }\n}\n","export function deepClone(obj, hash = new WeakMap()) {\n    // Do not try to clone primitives or functions\n    if (Object(obj) !== obj) return obj;\n    if (obj instanceof Function)\n      return undefined;\n    if (obj instanceof HTMLElement)\n      return obj.sharable?obj:undefined;\n    if (hash.has(obj)) return hash.get(obj); // Cyclic reference\n    var result = new obj.constructor();\n    // Register in hash    \n    hash.set(obj, result);\n    // Clone and assign enumerable own properties recursively\n    return Object.assign(result, ...Object.keys(obj).map (\n        key => ({ [key]: deepClone(obj[key], hash) }) ));\n}","import {deepClone} from './deepclone.js'\n\n\nexport class Session {\n  // domElement can be null, in which case this session will be initialised when its set with the setter.\n  constructor(ws, baseSession) {\n    this.sessionState = {\n      preventscroll: 0,\n      nextLayerUpdates: [],\n      comittedLayerUpdates: [],\n      layer_tree: [],\n      keyboard: {showing: false}\n    };\n\n    this.ws = ws;\n    this.onNewSession = () => {};\n    this.onSessionActivate = () => {};\n    this.onSessionSetHeight = () => {};\n\n    if (baseSession) {\n      this.sessionState = deepClone(baseSession.sessionState);\n    }\n\n    this.ws.eventListeners['PageStream.streamLayerInfo'] =  msg => {\n      this.sessionState.nextLayerUpdates.push(msg.layerUpdate);\n      // Create any sessions for event target clicks, because they could start sending data right away.\n      msg.layerUpdate.targets && msg.layerUpdate.targets.forEach(x=> {\n        x.sessionId && this.onNewSession(ws.ws, x.sessionId, this)\n      });\n    };\n\n    this.ws.eventListeners['PageStream.streamPropTrees'] =  params => {\n      this.sessionState.nextProptrees = JSON.parse(params.propertyTreesJSON);\n      this.fullUpdateRequired = true;\n    };\n    \n    this.ws.eventListeners['PageStream.frameDone'] = () => {\n      this.sessionState.comittedLayerUpdates = this.sessionState.comittedLayerUpdates.concat(this.sessionState.nextLayerUpdates);\n      this.sessionState.nextLayerUpdates = [];\n      if (this.sessionState.nextProptrees) {\n        this.sessionState.comittedProptrees = this.sessionState.nextProptrees;\n        delete this.sessionState.nextProptrees;\n      }\n      this.scheduleUpdateScreen();\n    };\n\n    this.ws.eventListeners['PageStream.keyboardStateChange'] = params => {\n      this.sessionState.keyboard = params;\n\n      this.updateKeyboard();\n    }\n\n  }\n\n  // Element ele is adopted by this Session.  It will be removed if a new element is bound.\n  set domElement(ele) {\n    // get rid of old element\n    this.domElement_ &&  this.domElement_.remove();\n\n    this.domElement_ = ele;\n    if (ele) {\n      ['touchStart', 'touchEnd', 'touchCancel', 'touchMove'].forEach(evt =>\n        ele.addEventListener(evt.toLowerCase(), this.touch.bind(this, evt), {passive: true}));\n\n      this.keyboard = document.createElement('textarea');\n      this.keyboard.style = \"width: 0px; height: 0px; position: absolute; z-index: -999\";\n      this.keyboard.oninput = this.keyboardHandler.bind(this);\n      this.keyboardUpdateBlockedCtr = 0;\n\n      ele.appendChild(this.keyboard);\n      this.updateKeyboard();\n    }\n\n    this.updateScreen();\n  }\n\n  updateKeyboard() {\n    if (this.keyboard && !this.keyboardUpdateBlockedCtr) {\n      var params = this.sessionState.keyboard;\n      this.keyboard.innerText = params.inputBoxValue;\n      this.keyboard.setSelectionRange(params.selectionStart, params.selectionEnd);\n      if (params.showing) {\n        this.keyboard.focus();\n        this.domElement_.onmousedown = (e) => {e.preventDefault();};\n      } else {\n        this.keyboard.blur();\n        this.domElement_.onmousedown = null;\n      }\n    }\n  }\n  async keyboardHandler(e) {\n    this.keyboardUpdateBlockedCtr++;\n\n    await this.ws.req(\"PageStream.setKeyboardState\", {\n      inputBoxValue: e.target.value,\n      selectionStart: e.target.selectionStart,\n      selectionEnd: e.target.selectionEnd\n    });\n\n    this.keyboardUpdateBlockedCtr--;\n  }\n\n  decodeLayerInfo(l) {\n    var decoded = l.split('\\n').map(x => x.split(':')).filter(x=>x.length>1).reduce((m, i) => (m[i[0].trim()] = i[1].trim(), m), {});\n\n    var res = {layerId: decoded.layer_id};\n    res.drawsContent = decoded.Bounds != '0x0';\n\n    res.name = decoded.name;\n    res.bounds = decoded.Bounds.split('x').map(x => parseInt(x));\n    res.offsetToTransformParent = decoded.OffsetToTransformParent.split(' ').map(x => parseFloat(x.replace(/[^\\d.-]/g, '')));\n    res.clip_tree_index = parseInt(decoded.clip_tree_index);\n    res.effect_tree_index = parseInt(decoded.effect_tree_index);\n    res.scroll_tree_index = parseInt(decoded.scroll_tree_index);\n    res.transform_tree_index = parseInt(decoded.transform_tree_index);\n    return res\n  }\n\n  createDOMTransformNode(t, zIndex, adopt) {\n    if (t.parent_id) {\n      if (!t.dom && adopt)\n        // See if there is an element we might adopt\n        if (adopt.adoptable) {\n          t.dom = adopt\n        }\n\n      var oldZIndex = t.zIndex || -1;\n      \n      if (oldZIndex < zIndex || !t.dom || t.dom.adoptable) {\n        t.zIndex = Math.max(zIndex, oldZIndex);\n        this.createDOMTransformNode(t.parent_id, zIndex, t.dom && t.dom.parentNode);\n      }\n\n      if (!t.dom) {\n        t.dom = document.createElement('div');\n        t.parent_id.dom.appendChild(t.dom);\n      }\n      t.dom.adoptable = false;\n      \n      if (t.dom.parentNode != t.parent_id.dom) {\n        t.parent_id.dom.appendChild(t.dom);\n      }\n      t.dom.classList.add('t');\n      t.dom.setAttribute('t'+t.id, '');\n      if (oldZIndex != t.zIndex)\n        t.dom.style.zIndex = t.zIndex;\n\n      if (t.clip) {\n        t.dom.style.width = t.clip.clip[2] + 'px';\n        t.dom.style.height = t.clip.clip[3] + 'px';\n        t.dom.style.top = t.clip.clip[1] + 'px';\n        t.dom.style.left = t.clip.clip[0] + 'px';\n        if (t.clip.clip[0] || t.clip.clip[1])\n          t.dom.style.transform = `matrix3d(1,0,0,0, 0,1,0,0, 0,0,1,0, ${t.clip.clip[0]},${t.clip.clip[1]},0,1) ` + this.toCss(t.local);\n        else\n          t.dom.style.transform = this.toCss(t.local);\n      } else {\n        t.dom.style.transform = this.toCss(t.local);\n      }\n      \n      if (t.scroll && this.sessionState.preventscrollElem != t.scroll.element_id.id_) {\n        // Perf bottleneck - server side scrolling disabled\n        //t.dom.scrollTop = t.scroll_offset[1];\n        //t.dom.scrollLeft = t.scroll_offset[0];\n      }\n      t.dom.onscroll = t.scroll?this.scrollHandler.bind(this, t):undefined;\n      t.dom.classList.toggle('scroll', !!t.scroll)\n\n    } else {\n      // Root transform is the one given when the class was constructed\n      t.dom = this.domElement_;\n    }\n  }\n\n  updateTargetHeights() {\n    this.sessionState.layer_tree.forEach(l => {\n      Object.keys(l.targets).forEach(backendNodeId => {\n        var t = l.targets[backendNodeId];\n        // TODO:  Should take into account all the layer transforms and scroll positions\n        t.sessionId && t.containingQuads && this.onSessionSetHeight(t.sessionId, t.containingQuads[0][1])\n      })\n    });\n  }\n\n  scrollHandler(t, evt) {\n    this.sessionState.preventscroll++;\n    this.sessionState.preventscrollElem = t.scroll.element_id.id_;\n    //if (t.dom.scrollTop == t.scroll_offset[1] && t.dom.scrollLeft==t.scroll_offset[0]) return;\n    this.ws.req('PageStream.setScroll', {backendNodeId:  t.scroll.element_id.id_, x: Math.floor(t.dom.scrollLeft), y: Math.floor(t.dom.scrollTop)}).then(x => {this.sessionState.preventscroll--;});\n    this.updateTargetHeights();\n  }\n  createDOMLayerImages(l) {\n    l.images && l.images.forEach(i => {\n      if (i.dom.activeInLayer != l) {\n        // TODO:  i.dom is shared with other sessions - implement some kind of refcounting & duplication here.\n        l.dom.appendChild(i.dom);\n        i.dom.style.position = 'absolute';\n        i.dom.style.top = i.clip.y + 'px';\n        i.dom.style.left = i.clip.x + 'px';\n        i.dom.width = i.clip.width;\n        i.dom.height = i.clip.height;\n        i.dom.activeInLayer = l;\n      }\n    });\n  }\n  createDOMLayerNode(l) {\n    if (!l.images || l.name == 'Frame Overlay Content Layer') return;\n\n    // Huh - looks like a scrollingcontents layer.  If so, set everything up appropriately\n    if (l.clip_tree_index.transform_id === l.scroll_tree_index.transform_id.parent_id  &&\n        l.scroll_tree_index.scrollable) {\n      l.scroll_tree_index.transform_id.scroll = l.scroll_tree_index;\n      l.scroll_tree_index.transform_id.clip = l.clip_tree_index;\n      \n      this.createDOMTransformNode(l.scroll_tree_index.transform_id, 0, l.scrolldom);\n      l.scrolldom = l.scroll_tree_index.transform_id.dom;\n    }\n\n    this.createDOMTransformNode(l.transform_tree_index, l.zIndex, l.dom && l.dom.parentNode);\n          \n    if (!l.dom) {\n      l.dom=document.createElement('div');  // layer\n    }\n    if (l.dom.parentNode != l.transform_tree_index.dom) {\n      // Transforms have changed - we need to add/move our layer elsewhere.\n      l.transform_tree_index.dom.appendChild(l.dom);\n    }\n    \n    this.createDOMLayerImages(l);\n\n    l.dom.style.top = l.offsetToTransformParent[1] + 'px';\n    l.dom.style.left = l.offsetToTransformParent[0]+ 'px';\n    l.dom.style.width=l.bounds[0] + 'px';\n    l.dom.style.height=l.bounds[1] + 'px';\n    l.dom.style.overflow = 'hidden';\n    l.dom.style.position = 'absolute';\n    l.dom.style.zIndex = l.zIndex;\n    l.dom.setAttribute('l'+l.layerId, l.name);\n    //l.dom.alt = l.name;\n    //l.dom.l = l;\n\n    l.targets && Object.keys(l.targets).forEach(t => {\n      this.createTargetNode(l.targets[t], l);\n    });\n\n  }\n\n  targetTouch(type, evt) {\n    // We want to detect 'click' events, but have to use touch instead because\n    // we'll need to cancel the global touch event touch if we detect a click, and the onclick() event\n    // fires too late to do that.\n    if (type=='touchStart' && evt.touches.length==1) {\n      evt.currentTarget.metadata.touchStarted = true;\n    } else if (type=='touchEnd' && evt.currentTarget.metadata.touchStarted) {\n      if (evt.currentTarget.metadata.sessionId) {\n        // Means we have preloaded this click - we just need to transfer to that session.\n        this.onSessionActivate(evt.currentTarget.metadata.sessionId);\n      }\n      this.ws.req('PageStream.clickNode', { backendNodeId: evt.currentTarget.metadata.backendNodeId } );\n      evt.cancel = true;\n    } else {\n      delete evt.currentTarget.metadata.touchStarted;\n    }\n  }\n\n  createTargetNode(t, l) {\n    if (!t.containingQuads) return;\n    var container = l.dom.parentNode;\n    if (!t.dom) {\n      t.dom=document.createElement('div');\n      ['touchStart', 'touchEnd', 'touchCancel', 'touchMove'].forEach(evt =>\n        t.dom.addEventListener(evt.toLowerCase(), this.targetTouch.bind(this, evt), {passive: true}));\n    }\n    if (t.dom.parentNode != container) container.appendChild(t.dom);\n    t.dom.style.left = t.containingQuads[0][0]+'px';\n    t.dom.style.top = t.containingQuads[0][1]+'px';\n    t.dom.style.width = (t.containingQuads[0][4]-t.containingQuads[0][0])+'px';\n    t.dom.style.height = (t.containingQuads[0][5]-t.containingQuads[0][1])+'px';\n\n    \n    t.dom.metadata = t;\n    t.dom.classList.add('link');\n    t.dom.classList.toggle('alive', !!t.sessionId);\n  }\n\n  toCss(matrix) {\n    var matrix = Array(16).fill().reverse().map((_,i) => matrix[Math.floor(i/4) + (i%4)*4]);\n    var res = 'matrix3d('+ matrix.join(',') + ')';\n    // Special case identity transform\n    if (res==\"matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)\") return '';\n    return res;\n  }\n\n\n  makeTrees(propTrees) {\n    var clip_tree = propTrees.clip_tree.nodes.reduce((map, obj) => (map[obj.id] = obj, map), []);\n    var effect_tree = propTrees.effect_tree.nodes.reduce((map, obj) => (map[obj.id] = obj, map), []);\n    var scroll_tree = propTrees.scroll_tree.nodes.reduce((map, obj) => (map[obj.id] = obj, map), []);\n    var transform_tree = propTrees.transform_tree.nodes.reduce((map, obj) => (map[obj.id] = obj, map), []);\n\n    var layer_tree = this.sessionState.layer_tree;\n\n    function get_tree_node(a) {\n      if (Number.isInteger(a)) return a;\n      if (a === undefined) return a;\n      return a.id;\n    }\n    layer_tree.forEach(l => {\n      l.clip_tree_index = clip_tree[get_tree_node(l.clip_tree_index)];\n      l.effect_tree_index = effect_tree[get_tree_node(l.effect_tree_index)];\n      l.scroll_tree_index = scroll_tree[get_tree_node(l.scroll_tree_index)];\n      l.transform_tree_index = transform_tree[get_tree_node(l.transform_tree_index)];\n    });\n    transform_tree.forEach(l => {\n      l.parent_id = transform_tree[get_tree_node(l.parent_id)];\n    });\n    scroll_tree.forEach(l => {\n      l.parent_id = scroll_tree[get_tree_node(l.parent_id)];\n      l.transform_id = transform_tree[get_tree_node(l.transform_id)];\n    });\n    effect_tree.forEach(l => {\n      l.parent_id = effect_tree[get_tree_node(l.parent_id)];\n      l.transform_id = transform_tree[get_tree_node(l.transform_id)];\n      l.clip_id = clip_tree[get_tree_node(l.clip_id)];\n    });\n    clip_tree.forEach(l => {\n      l.parent_id = clip_tree[get_tree_node(l.parent_id)];\n      l.transform_id = transform_tree[get_tree_node(l.transform_id)];\n    });\n    \n    this.sessionState = {...this.sessionState, clip_tree, effect_tree, scroll_tree, transform_tree, layer_tree};\n\n  }\n  scheduleUpdateScreen() {\n    if (this.requestAnimationFrameCallback) cancelAnimationFrame(this.requestAnimationFrameCallback);\n    this.requestAnimationFrameCallback = requestAnimationFrame(this.updateScreen.bind(this));\n  }\n  updateScreen() {\n    this.sessionState.comittedLayerUpdates.forEach(params => {\n      var l = this.sessionState.layer_tree[params.layerId] = this.sessionState.layer_tree[params.layerId] || { targets: {}};\n\n      if (params.layerDeleted || params.layerInfo || params.zIndex || params.targets) {\n        this.fullUpdateRequired = true;\n      }\n\n      if (params.layerDeleted) {\n        l.dom && l.dom.remove();\n        l.targets && Object.keys(l.targets).forEach(t => l.targets[t].dom && l.targets[t].dom.remove()); \n        delete this.sessionState.layer_tree[params.layerId];\n        return;\n      }\n\n      if (params.layerInfo) {\n        this.sessionState.layer_tree[params.layerId] = l = {...l, ...this.decodeLayerInfo(params.layerInfo)};\n      }\n\n      if (params.zIndex)\n        l.zIndex=params.zIndex;\n\n      if (params.bufferUpdates) {\n        l.images = l.images || [];\n\n        params.bufferUpdates.forEach(bufUpdate => {\n          // Cull images this new image covers up (note - this test could cull more things)\n          for (let i = l.images.length - 1; i >= 0; i--) {\n            if (l.images[i].clip.x >= bufUpdate.clip.x &&\n              l.images[i].clip.y >= bufUpdate.clip.y &&\n              l.images[i].clip.x + l.images[i].clip.width <= bufUpdate.clip.x + bufUpdate.clip.width &&\n              l.images[i].clip.y + l.images[i].clip.height <= bufUpdate.clip.y + bufUpdate.clip.height) {\n            l.images[i].dom.activeInLayer == l && l.images[i].dom.remove();\n            l.images.splice(i, 1);\n            }\n          }\n          var domImage;\n          if (bufUpdate.image) {\n            domImage = new Image();\n            domImage.src = bufUpdate.image;\n            domImage.decode();\n            // Indicates this HTMLElement can be referenced from multiple sessions.\n            domImage.sharable = true;\n          }\n          l.images.push({clip: bufUpdate.clip, dom: domImage});\n        });\n      }\n\n      if (params.targets) {\n        params.targets.forEach(t => {\n          if (t.targetDeleted) {\n            var old_target = l.targets[t.backendNodeId]\n            old_target.dom && old_target.dom.remove();\n            delete l.targets[t.backendNodeId];\n          } else {\n            l.targets[t.backendNodeId] = l.targets[t.backendNodeId] || {};\n            Object.assign(l.targets[t.backendNodeId], t);\n          }\n        });\n      };\n    });\n\n    this.sessionState.comittedLayerUpdates = [];\n\n    if (!this.domElement_) return;\n\n    // Mark all transform nodes as adoptable\n    var old_transform_tree = this.sessionState.transform_tree;\n    if (old_transform_tree) old_transform_tree.forEach(t => {\n      if (t.dom && t.parent_id) {\n        t.dom.adoptable=true\n      }\n\n    });\n\n    // apply proptrees\n    if (this.sessionState.comittedProptrees && this.fullUpdateRequired) {\n      this.makeTrees(this.sessionState.comittedProptrees);\n    }\n    \n    // Create or adopt all layers, (and by extension scrolls, clips, transforms and targets)\n    this.sessionState.layer_tree.forEach(l => {\n      if (this.fullUpdateRequired)\n        this.createDOMLayerNode(l);\n      else\n        this.createDOMLayerImages(l);\n    });\n\n    // remove unowned transform nodes\n    if (old_transform_tree) old_transform_tree.forEach(t => {\n      if (t.dom && (t.dom.adoptable==true))\n        t.dom.remove();\n    });\n    this.updateTargetHeights();\n  }\n\n  resize() {\n    this.ws.req('Emulation.setDeviceMetricsOverride', {\n      height: window.innerHeight,\n      width: Math.floor(window.innerWidth),\n      deviceScaleFactor: window.devicePixelRatio,\n      mobile: true\n    }); \n  }\n\n  touch(n, e){\n    if (e.cancel) {\n      n = 'touchCancel';\n    }\n    this.ws.req('Input.dispatchTouchEvent', {\n      type: n,\n      touchPoints: Array(...e.touches).map(t => { return {x: t.clientX, y: t.clientY, id:t.identifier}}),\n    });\n  }\n\n  destroy() {\n    this.ws.destroy();\n    this.domElement = null;\n  }\n}","// ***************   Settings\n// These values are used to allow this to either be hosted as a static file or replaced by a\n// server-side script to eliminate a server round-trip.\n\nlet options = {\n  // Websocket for server comms.  Method to select websocket:\n  //  * If available, connect to websocketServer.\n  //  * Otherwise, if available, connect to websocketPool.\n  //  * Otherwise, connect to document.location.host\n\n  //websocketServer: 'wss://server.example.com/',\n  //websocketServer: 'ws://localhost:12159',\n\n  // It's a dns based pool with a custom load balancing algorithm.\n  // servers are expected to register at n.serverpool.com, where n is an integer from 0 to ~ the pool\n  // size.  A few gaps doesn't matter.  If servers with low numbers get inundated with load-discovery-requests,\n  // take them down (should only happen >10k servers).\n  // The client will connect to 10 hosts logarithmicly spaced, \n  // and use whichever has the lowest published load scaled by response time.\n  // briskbrowser.com is provided without any SLA.  Expect to be blocked if you apply too much load.\n  //websocketPool: 'briskbrowser.com',\n\n  // Don't display previews of future windows\n  fullscreen: false,\n}\n\ntypeof BBOptionsOverrides !== 'undefined' && Object.assign(options, BBOptionsOverrides)\n\nimport {devToolsWebsocket, devToolsSession} from './devtoolswebsocket.js'\nimport {selectWebsocket} from './loadbalancer.js'\nimport {Session} from './session.js'\n\n\nclass Browser {\n  constructor(rootElement, options) {\n    this.rootElement = rootElement;\n    this.options = options;\n  }\n\n  async init() {\n    // get the websocket loading early in the page load.\n    let wsPromise = selectWebsocket(options.websocketServer, options.websocketPool);\n\n    var socket = await wsPromise;\n\n    var sessions = {};\n    var activeSession;\n\n    if (!window.navigator.userAgent.match(/Chrome\\/[.0-9]* Mobile/)) {\n      alert(\"Hold Up!  We only support Android Chrome right now...   Click OK to try anyway...   But it probably won't work :-(\")\n    }\n\n    window.sessions = sessions;  // for testing\n\n    // All these are run serially on connection, but none depend on a\n    // response from a request.  The intention is a server can fire\n    // off all these requests to the browser before the client even\n    // connects to speed up initial loading.\n    socket.req(undefined, 'Target.setDiscoverTargets', {discover: true});\n    socket.eventListeners['Target.targetCreated'] = function (msg) {\n      if (msg.targetInfo.type == 'page' && !this.attached) {\n        socket.req(undefined, 'Target.attachToTarget', {targetId: msg.targetInfo.targetId, flatten: true});\n        this.attached = true;\n      }\n    };\n\n    socket.eventListeners['Target.attachedToTarget'] = msg => {\n      // TODO:  Handle case of multiple targets/sessions/windows etc.\n      console.log(\"new target\", msg);\n      \n      var sess = addSession(socket,  msg.sessionId, null);\n      sessionActivate(msg.sessionId);\n\n      sess.resize();\n      sess.ws.req('Page.enable', {});\n      sess.ws.req('PageStream.enable', {fps: 0, targetBandwidth: 999999999});\n      sess.ws.req('Page.navigate', {url: currentURL()});\n    };\n\n    socket.eventListeners['Target.detachedFromTarget'] = msg => {\n      sessions[msg.sessionId].destroy();\n      delete sessions[msg.sessionId];\n      arrangeSessions();\n    }\n\n    socket.eventListeners['Target.targetInfoChanged'] = params => {\n      return; // TODO:  Fix\n      // Update URL and page title\n      if (params.targetInfo.url.startsWith('http'))\n        if (currentURL() != params.targetInfo.url)\n          history.pushState({}, \"test\", '/'+params.targetInfo.url);\n      // This doesn't work properly because the browser doesn't emit an event if\n      // the title changes without a navigation event happening.\n      document.title = params.targetInfo.title;\n    };\n\n\n    var resize = () => {\n      Object.values(sessions).forEach(x => x.resize());\n    }\n    window.addEventListener('resize', resize);\n\n\n  }\n\n  currentURL() {\n    var path = document.location.pathname;\n    var search = document.location.search;\n    if (path.startsWith('/http')) return path.substring(1)+search+document.location.hash;\n    if (search.startsWith('?http')) return search.substring(1)+document.location.hash;\n    return document.location.href;\n  }\n\n  arrangeSessions() {\n    return;\n    var ca = sessions[activeSession].childArrangement;\n    if (!ca) return;\n    var eligibleSessions = Object.keys(ca).filter(x => x in sessions);\n    eligibleSessions.sort((a,b) => ca[a] - ca[b]);\n\n    eligibleSessions.forEach((x, index)=> {\n      sessions[x].domElement_.style.setProperty(\"--height\", (index/(eligibleSessions.length)*100) + 'vh');\n    });\n  }\n\n  sessionSetHeight(fromSessionId, toSessionId, height) {\n    sessions[fromSessionId].childArrangement = sessions[fromSessionId].childArrangement || {};\n    sessions[fromSessionId].childArrangement[toSessionId] = height;\n    arrangeSessions();\n  }\n\n  sessionActivate(sessionId) {\n/*    Object.keys(sessions).forEach((sid) => {\n      //var cl = sessions[sid].domElement_.classList;\n      //cl.replace('active', 'old-active');\n      //cl.toggle('active', sid==sessionId);\n      sessions[sid].domElement = null;\n    }); */\n    var elem = document.createElement('bb-session');\n    document.querySelector('#recreation').appendChild(elem);\n    elem.classList.add('active');\n    activeSession && (sessions[activeSession].domElement = null);\n    sessions[sessionId].domElement = elem;\n\n    activeSession = sessionId;\n    arrangeSessions();\n  }\n\n  addSession(socket, sessionId, existingSession) {\n    if (sessions[sessionId]) return;\n    \n    \n    var ws = new devToolsSession(socket, sessionId);\n    \n    var sess = new Session(ws, existingSession);\n    sessions[sessionId] = sess;\n\n    \n    // Event emitted whenever this session wants to trigger the creation of a clone of itself.\n    sess.onNewSession = addSession;\n\n    // Event emitted whenever this session wants to activate another session.\n    sess.onSessionActivate = sessionActivate;\n\n    // UX data linkage to allow non-active sessions to be rendered on the screen at positions\n    // dependant on the links which will activate them.  Called repeatedly on scroll.\n    sess.onSessionSetHeight = sessionSetHeight.bind(this, sessionId);\n\n    return sess;\n  }\n\n}\n\n\n\n\n    \nwindow.addEventListener('DOMContentLoaded', async (event) => {\n\n  let b = Browser(document.quertSelector('#recreation'), options)\n\n  b.init();\n\n  \n});","import {devToolsWebsocket, devToolsSession} from './devtoolswebsocket.js'\n\n\n// Implements a stochastic client-side loadbalancer\nexport function selectWebsocket(websocketServer, websocketPool) {\n  return new Promise(function(resolve, reject) {\n    let socketPool = [];\n    if (websocketServer) {\n      socketPool.push({id: 0, ws: new devToolsWebsocket(websocketServer)});\n    } else if (websocketPool) {\n      socketPool = socketPool.concat([...Array(10).keys()]\n          .map(x => Math.floor(Math.random()*Math.pow(4,x)))\n          .map(x => { return {id: x, ws: new devToolsWebsocket('wss://' + x + '.' + websocketPool)}})\n        );\n    } else {\n      socketPool.push({id: 0, ws: new devToolsWebsocket(document.location.origin.replace('http', 'ws'))});\n    }\n    socketPool.doneCount = 0;\n    socketPool.highestOpen = -1;\n\n    function checkDone() {\n      if (socketPool.resolved) return;\n      if ((socketPool.doneCount/socketPool.length >= 0.9 && socketPool.highestOpen>=0)\n          || socketPool.doneCount==socketPool.length ) {\n        let goodSocketPool = socketPool.filter(x => x.load);\n        goodSocketPool.sort((a,b) => a.load - b.load);\n\n        socketPool.resolved = true;\n        // TODO:  Should skip first few here due to log sampling.\n        var selected = (goodSocketPool.length!=0)?goodSocketPool[0].ws:null;\n        if (selected) resolve(selected)\n        else reject(socketPool.lasterr);\n        socketPool.forEach(x => (x.ws!=selected) && x.ws.close());\n      }\n    }\n    socketPool.forEach(s => {\n      s.ws.onopen = async () => {\n        try {\n          s.load = socketPool.length==1?1:(await s.ws.req(undefined, 'Load.GetLoad', {}));\n        } catch {\n          s.load = 1;\n        };\n        socketPool.doneCount++;\n        socketPool.highestOpen = Math.max(socketPool.highestOpen, s.id);\n        checkDone();\n      };\n      s.ws.onerror = (err) => {socketPool.doneCount++; socketPool.lasterr=err; checkDone()};\n    });\n  });\n}\n"],"sourceRoot":""}